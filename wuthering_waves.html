<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wuthering Waves – Character Tracker</title>
  <link rel="stylesheet" href="css/wuwa/style.css">
</head>

<body>
  <main class="container">
    <h1 class="page-title">Wuthering Waves – Character Tracker</h1>
    <p class="page-subtitle">Resonance icons en weapon toggle werken alleen als Owned aan staat.</p>

    <div class="tabs" id="tabs">
      <button class="tab-btn active" data-tab="all">All</button>
      <button class="tab-btn" data-tab="five">5★</button>
      <button class="tab-btn" data-tab="four">4★</button>
      <button class="tab-btn" data-tab="standard">Standard</button>
      <button class="tab-btn" data-tab="owned">Owned</button>
      <button class="tab-btn" data-tab="notowned">Not Owned</button>
    </div>

    <div id="list" class="grid"></div>
  </main>

  <script src="js/wuwa/characters.js"></script>

  <script>
    const KEY = "ww_tracker_final_v2";
    const PLACEHOLDER = "assets/wuwa/resonance/placeholder.jpg";
    let ACTIVE_TAB = "all";

    function defaultChar(){
      return {
        owned:false,
        level:1,
        chain:0,
        weaponExtra:false,
        skills:{ basic:1, skill:1, forte:1, liberation:1, outro:1 }
      };
    }

    function load(){
      const s = localStorage.getItem(KEY);
      const d = s ? JSON.parse(s) : {};
      CHARACTERS.forEach(c=>{ if(!d[c.id]) d[c.id] = defaultChar(); });
      localStorage.setItem(KEY, JSON.stringify(d));
      return d;
    }
    function save(d){ localStorage.setItem(KEY, JSON.stringify(d)); }

    function clamp(v,min,max){
      v = Number(v);
      return isNaN(v) ? min : Math.max(min, Math.min(max, v));
    }

    function iconError(img){
      img.onerror=null;
      img.src=PLACEHOLDER;
    }

    function passesTab(c, d){
      if(ACTIVE_TAB === "five" && c.rarity !== "5★") return false;
      if(ACTIVE_TAB === "four" && c.rarity !== "4★") return false;
      if(ACTIVE_TAB === "standard" && c.standard !== true) return false;
      if(ACTIVE_TAB === "owned" && d.owned !== true) return false;
      if(ACTIVE_TAB === "notowned" && d.owned !== false) return false;
      return true;
    }

    function render(){
      const data = load();
      const list = document.getElementById("list");
      list.innerHTML = "";

      CHARACTERS.forEach(c=>{
        const d = data[c.id];
        const owned = d.owned;
        if(!passesTab(c, d)) return;

        const hasWeapons = Array.isArray(c.weapons) && c.weapons.length >= 1;

        const el = document.createElement("div");
        el.className = "card-wrap";

        el.innerHTML = `
          <div class="tracker-card ${owned ? "is-owned" : ""}">

            <div class="card-top">
              <img src="${c.image}" class="char-img ${owned ? "" : "dim"}" onerror="this.style.display='none'">

              <div class="right">
                <div class="header-row">
                  <div class="title-area">
                    <div class="char-name">${c.name}</div>
                    <div class="meta">
                      <span class="pill">${c.rarity}</span>
                      ${c.standard ? `<span class="pill pill-standard">Standard</span>` : ``}
                    </div>
                  </div>

                  <label class="owned-inline">
                    <input type="checkbox" ${owned ? "checked" : ""} onchange="setOwned('${c.id}', this.checked)">
                    <span>Owned</span>
                  </label>
                </div>

                <div class="mini-row">
                  <div class="mini-box level-box">
                    <span class="mini-label">Level</span>
                    <input class="mini-input" value="${d.level}" oninput="setLevel('${c.id}', this.value)">
                  </div>

                  ${hasWeapons ? `
                    <div class="mini-box weapon-box">
                      <img src="${c.weapons[0]}" class="weapon-icon base" onerror="this.style.display='none'">
                      ${c.weapons[1] ? `
                        <img
                          src="${c.weapons[1]}"
                          class="weapon-icon extra ${owned ? "clickable" : "disabled"} ${d.weaponExtra ? "active" : ""}"
                          ${owned ? `onclick="toggleWeaponExtra('${c.id}')"` : ``}
                          onerror="this.style.display='none'">
                      ` : ``}
                    </div>
                  ` : `<div class="mini-box weapon-box empty"></div>`}
                </div>
              </div>

              <!-- ✅ chain pill staat NU onder de hele top (onder profiel + info) -->
              <div class="chain-pill">
                ${c.icons.map((icon,i)=>`
                  <img
                    src="${icon}"
                    class="chain-icon ${d.chain>=i+1 ? "active" : ""} ${owned ? "clickable" : "disabled"}"
                    ${owned ? `onclick="setChain('${c.id}',${i+1})"` : ""}
                    onerror="iconError(this)">
                `).join("")}
              </div>
            </div>

            <div class="divider"></div>

            <div class="skills">
              ${Object.entries(d.skills).map(([k,v])=>`
                <div class="skill-row">
                  <span class="skill-name">${k}</span>
                  <input class="skill-input" value="${v}" oninput="setSkill('${c.id}','${k}', this.value)">
                </div>
              `).join("")}
            </div>
          </div>
        `;

        list.appendChild(el);
      });
    }

    function setOwned(id,val){
      const d = load();
      d[id].owned = val;
      if(!val){
        d[id].chain = 0;
        d[id].weaponExtra = false;
      }
      save(d);
      render();
    }

    function setChain(id,val){
      const d = load();
      d[id].chain = (d[id].chain === val) ? 0 : val;
      save(d);
      render();
    }

    function toggleWeaponExtra(id){
      const d = load();
      d[id].weaponExtra = !d[id].weaponExtra;
      save(d);
      render();
    }

    function setLevel(id,val){
      const d = load();
      d[id].level = clamp(val, 1, 90);
      save(d);
    }

    function setSkill(id,skill,val){
      const d = load();
      d[id].skills[skill] = clamp(val, 1, 10);
      save(d);
    }

    document.getElementById("tabs").addEventListener("click", (e)=>{
      const btn = e.target.closest(".tab-btn");
      if(!btn) return;
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      ACTIVE_TAB = btn.dataset.tab;
      render();
    });

    render();
  </script>
</body>
</html>
